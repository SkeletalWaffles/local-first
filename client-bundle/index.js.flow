// @flow
// import 'regenerator-runtime/runtime';
import * as hlc from "../hybrid-logical-clock/src/index.js";
export type { HLC } from "../hybrid-logical-clock/src/index.js";
import * as crdt from "../nested-object-crdt/src/new.js";
export type { Delta, CRDT as Data } from "../nested-object-crdt/src/types.js";
import * as rich from "../rich-text-crdt/index.js";
import type { Schema } from "../nested-object-crdt/src/schema.js";
export { validateDelta, validate, subSchema } from "../nested-object-crdt/src/schema.js";
export { hlc, crdt, rich };
export type { Schema };

import type { CRDTImpl } from "../core/src/shared.js";
import type { Client } from "../core/src/types.js";
export type { Client, Collection } from "../core/src/types.js";

import { default as createBlobClient } from "../core/src/blob/create-client.js";
import { default as makeBlobPersistence } from "../idb/src/blob.js";
import {
    default as createBasicBlobNetwork,
    type SyncStatus as BlobSyncStatus,
} from "../core/src/blob/basic-network.js";

export { default as createBlobClient } from "../core/src/blob/create-client.js";
export { default as makeBlobPersistence } from "../idb/src/blob.js";
export { default as createBasicBlobNetwork } from "../core/src/blob/basic-network.js";

import { default as createDeltaClient } from "../core/src/delta/create-client.js";
import { default as makeDeltaPersistence, type IndexConfig } from "../idb/src/delta.js";
import { default as createPollingNetwork } from "../core/src/delta/polling-network.js";
import {
    default as createWebSocketNetwork,
    type SyncStatus,
} from "../core/src/delta/websocket-network.js";
import { default as makeDeltaInMemoryPersistence } from "../idb/src/delta-mem.js";

export { default as makeDeltaInMemoryPersistence } from "../idb/src/delta-mem.js";
export { default as createDeltaClient } from "../core/src/delta/create-client.js";
export { default as makeDeltaPersistence } from "../idb/src/delta.js";
export { default as createPollingNetwork } from "../core/src/delta/polling-network.js";
export { default as createWebSocketNetwork, SyncStatus } from "../core/src/delta/websocket-network.js";

export {
    PersistentClock,
    localStorageClockPersist,
    inMemoryClockPersist,
} from "../core/src/persistent-clock.js";

import {
    PersistentClock,
    localStorageClockPersist,
    inMemoryClockPersist,
} from "../core/src/persistent-clock.js";

type Data = crdt.CRDT<any, any>;
type Delta = crdt.Delta<any, any, rich.Delta>;

const otherMerge = (v1, m1, v2, m2) => {
    return { value: rich.merge(v1, v2), meta: null };
};
const applyOtherDelta = (text: rich.CRDT, meta: null, delta: rich.Delta) => {
    return {
        value: rich.apply(text, delta),
        meta,
    };
};

const invertOtherDelta = otherDelta => {
    console.log('cant invert rich text deltas yet');
    return null;
};

export const clientCrdtImpl: CRDTImpl<Delta, Data> = {
    merge: (one: ?Data, two: Data): Data => {
        if (!one) return two;
        return crdt.mergeTwo(one, two, (v1, _, v2, __) => ({
            value: rich.merge(v1, v2),
            meta: null,
        }));
    },
    latestStamp: data => crdt.latestStamp(data, () => null),
    value: d => d.value,
    get: crdt.get,
    createEmpty: stamp => crdt.createEmpty(stamp),
    deltas: {
        ...crdt.deltas,
        invert: (base, delta, getStamp) => crdt.invert(base, delta, getStamp, invertOtherDelta),
        stamp: data => crdt.deltas.stamp(data, () => null),
        restamp: (delta: Delta, stamp: string) => crdt.restamp(delta, stamp),
        apply: (base, delta) => crdt.applyDelta(base, delta, (applyOtherDelta: any), otherMerge),
    },
    createValue: (value, stamp, getStamp, schema) => {
        return crdt.createWithSchema(value, stamp, getStamp, schema, value => null);
    },
};

const nullNetwork = (_, __, ___) => ({
    initial: { status: 'disconnected' },
    createSync: (_, __, ___) => () => {},
});

export const createPersistedBlobClient = (
    name: string,
    schemas: { [key: string]: Schema },
    url: ?string,
    version: number,
): Client<BlobSyncStatus> => {
    return createBlobClient<Delta, Data, BlobSyncStatus>(
        name,
        clientCrdtImpl,
        schemas,
        new PersistentClock(localStorageClockPersist(name)),
        makeBlobPersistence(name, Object.keys(schemas), version),
        url != null ? createBasicBlobNetwork<Delta, Data>(url) : nullNetwork,
    );
};

export const createPersistedDeltaClient = (
    name: string,
    schemas: { [colid: string]: Schema },
    url: ?string,
    version: number,
    indexes: { [colid: string]: { [indexId: string]: IndexConfig } },
): Client<SyncStatus> => {
    return createDeltaClient(
        name,
        clientCrdtImpl,
        schemas,
        new PersistentClock(localStorageClockPersist(name)),
        makeDeltaPersistence(name, Object.keys(schemas), version, indexes),
        url != null ? createWebSocketNetwork(url) : nullNetwork,
    );
};

export const createInMemoryDeltaClient = (
    schemas: { [key: string]: Schema },
    url: string,
): Client<SyncStatus> => {
    return createDeltaClient(
        'in-memory',
        clientCrdtImpl,
        schemas,
        new PersistentClock(inMemoryClockPersist()),
        makeDeltaInMemoryPersistence(Object.keys(schemas)),
        createWebSocketNetwork(url),
    );
};
